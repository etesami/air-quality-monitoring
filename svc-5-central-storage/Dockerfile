FROM golang:1.23 AS build

WORKDIR /app

COPY go.mod go.sum ./
RUN go mod download

COPY . .

RUN go build -o central-storage cmd/main.go

FROM alpine:3.21.3

WORKDIR /root/
COPY --from=build /app/central-storage .

ARG SVC_PROCESSOR_ADDR
ARG SVC_PROCESSOR_PORT
ARG SVC_AGGR_STRG_ADDR
ARG SVC_AGGR_STRG_PORT
ARG SVC_DP_METRIC_ADDR
ARG SVC_DP_METRIC_PORT
# Frequency in seconds
ARG UPDATE_FREQUENCY

ENV SVC_LO_PROCESSOR_ADDR=${SVC_PROCESSOR_ADDR}
ENV SVC_LO_PROCESSOR_PORT=${SVC_PROCESSOR_PORT}
ENV SVC_TA_AGGR_STRG_ADDR=${SVC_AGGR_STRG_ADDR}
ENV SVC_TA_AGGR_STRG_PORT=${SVC_AGGR_STRG_PORT}
ENV SVC_LO_DP_METRIC_ADDR=${SVC_DP_METRIC_ADDR}
ENV SVC_LO_DP_METRIC_PORT=${SVC_DP_METRIC_PORT}
ENV SVC_LO_DP_UPDATE_FREQUENCY=${UPDATE_FREQUENCY}

EXPOSE 50052
CMD ["./central-storage"]
