FROM golang:1.23 AS build

WORKDIR /app

COPY go.mod go.sum ./
RUN go mod download

COPY . .

RUN go build -o ingestor cmd/main.go

FROM alpine:3.21.3

WORKDIR /root/
COPY --from=build /app/ingestor .

ARG SVC_INGST_ADDR
ARG SVC_INGST_PORT
ARG SVC_STRG_ADDR
ARG SVC_STRG_PORT
ARG SVC_METRIC_ADDR
ARG SVC_METRIC_PORT
# Frequency in seconds
ARG UPDATE_FREQUENCY

ENV SVC_LO_INGST_ADDR=${SVC_INGST_ADDR}
ENV SVC_LO_INGST_PORT=${SVC_INGST_PORT}
ENV SVC_TA_LO_STRG_ADDR=${SVC_STRG_ADDR}
ENV SVC_TA_LO_STRG_PORT=${SVC_STRG_PORT}
ENV SVC_LO_INGST_METRIC_ADDR=${SVC_METRIC_ADDR}
ENV SVC_LO_INGST_METRIC_PORT=${SVC_METRIC_PORT}
ENV SVC_LO_INGST_UPDATE_FREQUENCY=${UPDATE_FREQUENCY}

EXPOSE 50052
CMD ["./ingestor"]
