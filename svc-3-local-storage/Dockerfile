FROM golang:1.23 AS build

WORKDIR /app

COPY go.mod go.sum ./
RUN go mod download

COPY . .

RUN go build -o local-storage cmd/main.go

FROM alpine:3.21.3

WORKDIR /root/
COPY --from=build /app/local-storage .

ARG SVC_STRG_ADDR
ARG SVC_STRG_PORT
ARG SVC_PROCESSOR_ADDR
ARG SVC_PROCESSOR_PORT
ARG SVC_STRG_METRIC_ADDR
ARG SVC_STRG_METRIC_PORT
# Frequency in minutes
ARG UPDATE_FREQUENCY

ENV SVC_LO_STRG_ADDR=${SVC_STRG_ADDR}
ENV SVC_LO_STRG_PORT=${SVC_STRG_PORT}
ENV SVC_TA_PROCESSOR_ADDR=${SVC_PROCESSOR_ADDR}
ENV SVC_TA_PROCESSOR_PORT=${SVC_PROCESSOR_PORT}
ENV SVC_LO_STRG_METRIC_ADDR=${SVC_STRG_METRIC_ADDR}
ENV SVC_LO_STRG_METRIC_PORT=${SVC_STRG_METRIC_PORT}
ENV SVC_LO_STRG_UPDATE_FREQUENCY=${UPDATE_FREQUENCY}

EXPOSE 50052
CMD ["./local-storage"]
